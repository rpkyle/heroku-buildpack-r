#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-path>

# fail fast
set -eo pipefail

set -x

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Export Path variables, for use in sub-scripts.
export BUILD_DIR CACHE_DIR ENV_DIR

DEFAULT_R_VERSION=4.0.1

R_VERSION="$DEFAULT_R_VERSION"

R_MAJOR_VERSION="${R_VERSION%%.*}"

#GCC_VERSION="$(gcc --version | grep ^gcc | sed 's/^.* //g')"
GCC_VERSION=7.5.0

START_TIME="$(date -u +%s)"

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo -n "-----> Installing system dependencies...." | indent
echo
mkdir -p /app/.heroku/r/usr/bin

# install gfortran
curl -sL https://storage.googleapis.com/dashr/heroku-18/gfortran/gfortran-${GCC_VERSION}.tgz -o /tmp/gfortran-${GCC_VERSION}.tgz && tar -xzf /tmp/gfortran-${GCC_VERSION}.tgz -C /app/.heroku/r && rm /tmp/gfortran-${GCC_VERSION}.tgz
ln -s /app/.heroku/r/usr/bin/x86_64-linux-gnu-gfortran-7 /app/.heroku/r/usr/bin/gfortran
ln -s /app/.heroku/r/usr/bin/x86_64-linux-gnu-gfortran-7 /app/.heroku/r/usr/bin/gfortran-7

# install g++
curl -sL https://storage.googleapis.com/dashr/heroku-18/g++/g++-7.4.0-1.tgz -o /tmp/g++-7.4.0-1.tgz && tar -xzf /tmp/g++-7.4.0-1.tgz -C /app/.heroku/r && rm /tmp/g++-7.4.0-1.tgz
ln -s /app/.heroku/r/usr/bin/x86_64-linux-gnu-g++-7 /app/.heroku/r/usr/bin/g++

# install zlib1g-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/zlib1g/zlib1g-dev-1.2.11.tgz -o /tmp/zlib1g-dev-1.2.11.tgz && tar -xzf /tmp/zlib1g-dev-1.2.11.tgz -C /app/.heroku/r && rm /tmp/zlib1g-dev-1.2.11.tgz

# install libbz2-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/libbz2/libbz2-dev-1.0.6-8.tgz -o /tmp/libbz2-dev-1.0.6-8.tgz && tar -xzf /tmp/libbz2-dev-1.0.6-8.tgz -C /app/.heroku/r && rm /tmp/libbz2-dev-1.0.6-8.tgz

# install liblzma-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/liblzma/liblzma-dev-5.2.2-1.3.tgz -o /tmp/liblzma-dev-5.2.2-1.3.tgz && tar -xzf /tmp/liblzma-dev-5.2.2-1.3.tgz -C /app/.heroku/r && rm /tmp/liblzma-dev-5.2.2-1.3.tgz
ln -s /lib/x86_64-linux-gnu/liblzma.so.5.2.2 /app/.heroku/r/usr/lib/x86_64-linux-gnu/liblzma.so

# install libcurl4-openssl-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/libcurl4/libcurl4-openssl-dev-7.58.0-2.tgz -o /tmp/libcurl4-openssl-dev-7.58.0-2.tgz && tar -xzf /tmp/libcurl4-openssl-dev-7.58.0-2.tgz -C /app/.heroku/r && rm /tmp/libcurl4-openssl-dev-7.58.0-2.tgz
ln -s /usr/lib/x86_64-linux-gnu/libcurl.so.4.5.0 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libcurl.so

# install libpcre2-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/libpcre2/libpcre2-dev-10.31-2.tgz -o /tmp/libpcre2-dev-10.31-2.tgz && tar -xzf /tmp/libpcre2-dev-10.31-2.tgz -C /app/.heroku/r && rm /tmp/libpcre2-dev-10.31-2.tgz
ln -s /usr/lib/x86_64-linux-gnu/libpcre2-16.so.0.7.0 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libpcre2-16.so
ln -s /usr/lib/x86_64-linux-gnu/libpcre2-32.so.0.7.0 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libpcre2-32.so
ln -s /usr/lib/x86_64-linux-gnu/libpcre2-8.so.0.7.0 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libpcre2-8.so
ln -s /usr/lib/x86_64-linux-gnu/libpcre2-posix.so.2.0.0 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libpcre2-posix.so

# install libreadline-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/libreadline/libreadline-dev-7.0-3.tgz -o /tmp/libreadline-dev-7.0-3.tgz && tar -xzf /tmp/libreadline-dev-7.0-3.tgz -C /app/.heroku/r && rm /tmp/libreadline-dev-7.0-3.tgz
ln -s /lib/x86_64-linux-gnu/libreadline.so.7 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libreadline.so
ln -s /lib/x86_64-linux-gnu/libhistory.so.7 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libhistory.so

# install libtinfo-dev
curl -sL https://storage.googleapis.com/dashr/heroku-18/libtinfo/libtinfo-dev-6.1-1.tgz -o /tmp/libtinfo-dev-6.1-1.tgz && tar -xzf /tmp/libtinfo-dev-6.1-1.tgz -C /app/.heroku/r && rm /tmp/libtinfo-dev-6.1-1.tgz
ln -s /usr/lib/x86_64-linux-gnu/libtic.so.5 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libtic.so
ln -s /lib/x86_64-linux-gnu/libtinfo.so.5 /app/.heroku/r/usr/lib/x86_64-linux-gnu/libtinfo.so 

export PATH="/app/.heroku/r/usr/bin:$PATH"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.heroku/r/lib:/app/.heroku/r/usr/lib"
export FC=gfortran

echo -n "-----> Fetching R $R_VERSION source tarball...." | indent
echo
curl -sLO https://cran.rstudio.com/src/base/R-${R_MAJOR_VERSION}/R-${R_VERSION}.tar.gz

echo -n "-----> Unpacking R $R_VERSION source tarball...." | indent
echo
tar -xzf R-${R_VERSION}.tar.gz -C /tmp

#echo -n "-----> Installing pandoc...." | indent
#echo
#curl -vs -L https://github.com/jgm/pandoc/releases/download/2.9.2.1/pandoc-2.9.2.1-1-amd64.deb -o /tmp/pandoc.deb && dpkg -i /tmp/pandoc.deb && rm /tmp/pandoc.deb

echo -n "-----> Installing R $R_VERSION...." | indent
echo
chmod u+x /tmp/R-${R_VERSION}/configure && /tmp/R-${R_VERSION}/configure \
      --prefix=/app/.heroku/r/usr/bin/R/${R_VERSION} \
      --enable-memory-profiling \
      --enable-R-shlib \
      --with-blas \
      --with-lapack \
      --with-x=no \
      --includedir=/app/.heroku/r/usr/include \
      --libdir=/app/.heroku/r/usr/lib \
      F77=gfortran

chmod u+x /tmp/R-${R_VERSION}/make && /tmp/R-${R_VERSION}/make -j4
/tmp/R-${R_VERSION}/make install

echo -n "-----> Adding symlinks in /usr/local/bin...." | indent
echo
ln -s /app/usr/bin/R/${R_VERSION}/bin/R /app/usr/local/bin/R
ln -s /app/usr/bin/R/${R_VERSION}/bin/Rscript /app/usr/local/bin/Rscript

echo "-----> Done" | indent
echo

# debug
END_TIME="$(date -u +%s)"
ELAPSED="$(($END_TIME-$START_TIME))"
echo "Build took $ELAPSED seconds to complete" | indent
