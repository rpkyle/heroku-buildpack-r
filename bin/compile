#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-path>

# fail fast
set -eo pipefail

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Export Path variables, for use in sub-scripts.
export BUILD_DIR CACHE_DIR ENV_DIR

DEFAULT_R_VERSION=4.0.1

R_VERSION="$DEFAULT_R_VERSION"

R_MAJOR_VERSION="${R_VERSION%%.*}"

START_TIME="$(date -u +%s)"

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo -n "-----> Fetching R $R_VERSION source tarball...." | indent
curl -LO https://cran.rstudio.com/src/base/R-${R_MAJOR_VERSION}/R-${R_VERSION}.tar.gz

echo -n "-----> Unpacking R $R_VERSION source tarball...." | indent
tar -xzvf R-${R_VERSION}.tar.gz -C /tmp

echo -n "-----> Installing R $R_VERSION...." | indent
chmod u+x /tmp/R-${R_VERSION}/configure && ./tmp/R-${R_VERSION}/configure \
      --prefix=/app/R/${R_VERSION} \
      --enable-memory-profiling \
      --enable-R-shlib \
      --with-blas \
      --with-lapack

chmod u+x /tmp/R-${R_VERSION}/make && ./tmp/R-${R_VERSION}/make -j4
./tmp/R-${R_VERSION}/make install

echo -n "-----> Adding symlinks in /usr/local/bin...." | indent
ln -s /app/R/${R_VERSION}/bin/R /usr/local/bin/R
ln -s /app/R/${R_VERSION}/bin/Rscript /usr/local/bin/Rscript

echo "-----> Done" | indent

# debug
END_TIME="$(date -u +%s)"
ELAPSED="$(($END_TIME-$START_TIME))"
echo "Build took $ELAPSED seconds to complete" | indent
