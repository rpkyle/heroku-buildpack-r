#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <r-version>

# fail fast
set -e

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
R_VERSION=$3

DEFAULT_R_VERSION=4.0.1

if [[ "$R_VERSION" == "null" ]]; then
  R_VERSION="$DEFAULT_R_VERSION"
fi

R_MAJOR_VERSION="${R_VERSION%%.*}"

echo -n "-----> Fetching R $R_VERSION source tarball...."
curl -LO https://cran.rstudio.com/src/base/R-${R_MAJOR_VERSION}/R-${R_VERSION}.tar.gz

echo -n "-----> Unpacking R $R_VERSION source tarball...."
tar -xzvf R-${R_VERSION}.tar.gz -C /tmp

echo -n "-----> Installing R $R_VERSION...."
mkdir /app
./tmp/configure \
      --prefix=/app/R/${R_VERSION} \
      --enable-memory-profiling \
      --enable-R-shlib \
      --with-blas \
      --with-lapack

./tmp/make -j4
sudo /tmp/make install

echo -n "-----> Adding symlinks in /usr/local/bin...."
sudo ln -s /app/R/${R_VERSION}/bin/R /usr/local/bin/R
sudo ln -s /app/R/${R_VERSION}/bin/Rscript /usr/local/bin/Rscript

echo "-----> Done"

